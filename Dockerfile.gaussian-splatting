# ======================================================================
#   Gaussian Splatting Full Environment
#   CUDA 11.8 + Ubuntu 22.04 + Python 3.10 + PyTorch 2.0.1 + COLMAP 3.8 + Ceres 2.1
#   100% version-compatible, no OpenGL or Python mismatches
# ======================================================================

FROM nvidia/cuda:11.8.0-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

# ----------------------------------------------------------------------
# Base dependencies
# ----------------------------------------------------------------------
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-dev python3-distutils python3-setuptools python3-venv \
    git wget curl build-essential cmake pkg-config ninja-build \
    libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 ffmpeg unzip \
    && rm -rf /var/lib/apt/lists/*

RUN python3 -m pip install --upgrade pip==23.3.1 setuptools==68.2.2 wheel==0.41.2

# ----------------------------------------------------------------------
# Install COLMAP build dependencies
# ----------------------------------------------------------------------
RUN apt-get update && apt-get install -y \
    libboost-program-options-dev libboost-filesystem-dev libboost-graph-dev libboost-system-dev libboost-test-dev \
    libeigen3-dev libsuitesparse-dev libfreeimage-dev libgoogle-glog-dev libgflags-dev \
    libatlas-base-dev libblas-dev liblapack-dev libflann-dev libmetis-dev libsqlite3-dev \
    libgl1-mesa-dev libglu1-mesa-dev libglew-dev && \
    rm -rf /var/lib/apt/lists/*

# ----------------------------------------------------------------------
# Install Ceres Solver (2.1.0)
# ----------------------------------------------------------------------
RUN git clone --branch 2.1.0 https://github.com/ceres-solver/ceres-solver.git /tmp/ceres && \
    cd /tmp/ceres && mkdir build && cd build && \
    cmake .. -DBUILD_TESTING=OFF -DBUILD_EXAMPLES=OFF -DCMAKE_BUILD_TYPE=Release && \
    make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/ceres

# ----------------------------------------------------------------------
# Build COLMAP (3.8) – headless, patched for GL constants
# ----------------------------------------------------------------------
RUN git clone --branch 3.8 https://github.com/colmap/colmap.git /tmp/colmap && \
    cd /tmp/colmap && \
    sed -i '1i#define GL_LUMINANCE 0x1909\n#define GL_UNSIGNED_BYTE 0x1401' src/feature/sift.cc && \
    mkdir build && cd build && \
    cmake .. \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CUDA_ARCHITECTURES="75;80;86" \
      -DGUI_ENABLED=OFF \
      -DOPENGL_ENABLED=OFF \
      -DQt5_DIR=/usr/lib/x86_64-linux-gnu/cmake/Qt5 && \
    make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/colmap

# ----------------------------------------------------------------------
# PyTorch (2.0.1 + cu118) – exact CUDA 11.8 match
# ----------------------------------------------------------------------
RUN pip install --no-cache-dir \
    torch==2.0.1+cu118 torchvision==0.15.2+cu118 torchaudio==2.0.2+cu118 \
    --index-url https://download.pytorch.org/whl/cu118

# ----------------------------------------------------------------------
# Python scientific and I/O packages
# ----------------------------------------------------------------------
RUN pip install --no-cache-dir \
    numpy==1.26.4 opencv-python==4.9.0.80 pillow==10.2.0 tqdm==4.66.1 \
    matplotlib==3.8.2 plyfile==1.0.3 open3d==0.18.0 imageio==2.34.1 imageio-ffmpeg==0.5.1

# ----------------------------------------------------------------------
# Gaussian Splatting repo (Graphdeco)
# ----------------------------------------------------------------------
RUN git clone --recursive https://github.com/graphdeco-inria/gaussian-splatting.git /workspace/gaussian-splatting


# ----------------------------------------------------------------------
# Workspace setup
# ----------------------------------------------------------------------
WORKDIR /workspace
RUN mkdir -p /workspace/data /workspace/outputs /workspace/scripts/Plugins/RealityStream

# Copy the conversion script
COPY convert_gaussian_ply.py /workspace/scripts/Plugins/RealityStream/convert_gaussian_ply.py
RUN chmod +x /workspace/scripts/Plugins/RealityStream/convert_gaussian_ply.py

CMD ["bash"]
